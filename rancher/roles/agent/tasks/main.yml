#安装httplib2
- name: install httplib2
  yum: name=python-httplib2 state=present

- name: Get the default project id
  action: uri
    method=GET
    user={{ rancher_access_key }}
    password={{ rancher_secret_key }}
    status_code=200
    url="http://{{ rancher_server }}:{{ rancher_port }}/v1/projects" return_content=yes
  register: project_id

- name: Return the registration token URL of Rancher server
  action: uri 
    method=POST
    status_code=201
    user={{ rancher_access_key }}
    password={{ rancher_secret_key }}
    url="http://{{ rancher_server }}:{{ rancher_port }}/v1/registrationtokens?projectId={{ project_id.json['data'][0]['id'] }}" return_content=yes
  register: rancher_token_url

- name: return the registration URL of Rancher server
  action: uri 
    method=GET 
    user={{ rancher_access_key }}
    password={{ rancher_secret_key }}
    url={{ rancher_token_url.json['links']['self'] }} return_content=yes
  register: rancher_token

- name: pull images
  command: docker pull rancher/agent:"v{{ rancher_agent_version }}"

- name: check if the rancher-agent is running
  command: docker ps
  register: containers

- name: register the Host machine with the Rancher server
  command: docker run -e CATTLE_AGENT_IP="{{ ansible_local_host }}" -d --privileged -v /var/run/docker.sock:/var/run/docker.sock -v /var/lib/rancher:/var/lib/rancher rancher/agent:v{{ rancher_agent_version }} "{{ rancher_token.json['registrationUrl'] }}"
  when: containers.stdout.find('rancher-agent') == -1
